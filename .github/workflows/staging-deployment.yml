name: Staging Deployment

on:
  push:
    branches:
      - develop
      - staging
  pull_request:
    branches:
      - develop
      - staging
    types: [closed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - uat

permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  deploy-to-staging:
    name: Deploy to Staging/UAT
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Get deployment info
        id: deployment-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ github.event.inputs.environment || "staging" }}',
              description: 'Automated staging deployment',
              required_contexts: [],
              auto_merge: false
            });
            
            core.setOutput('deployment_id', deployment.data.id);
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'in_progress',
              description: 'Deployment in progress...'
            });

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          if [ -f package.json ]; then npm ci; fi

      - name: Build application
        run: |
          # Add your build commands here
          echo "Building application..."
          # Example: npm run build, python setup.py build, etc.

      - name: Run tests
        run: |
          # Run tests before deployment
          echo "Running tests..."
          # Add your test commands here

      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "Commit: ${{ steps.deployment-info.outputs.commit_sha }}"
          echo "Author: ${{ steps.deployment-info.outputs.author }}"
          echo "Time: ${{ steps.deployment-info.outputs.deployment_time }}"
          
          # Add your actual deployment commands here
          # Examples:
          # - SSH deployment
          # - Docker deployment
          # - Cloud platform deployment (AWS, GCP, Azure)
          # - Frappe bench commands
          
          echo "âœ… Deployment completed successfully"

      - name: Update deployment status - success
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.deployment_id }},
              state: 'success',
              description: 'Deployment successful',
              environment_url: '${{ secrets.STAGING_URL || "https://staging.example.com" }}'
            });

      - name: Update deployment status - failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.deployment_id }},
              state: 'failure',
              description: 'Deployment failed'
            });

      - name: Staging Deployment Bot Comment
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const stagingUrl = '${{ secrets.STAGING_URL || "https://staging.example.com" }}';
            const commitSha = '${{ steps.deployment-info.outputs.commit_sha }}';
            
            // Get existing comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.data.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ðŸ¤– Staging Deployment Bot')
            );
            
            const comment = `## ðŸ¤– Staging Deployment Bot

âœ… **Staging Deployment**: Complete

| Detail | Value |
|--------|-------|
| **Environment** | Staging |
| **Commit** | \`${commitSha.substring(0, 7)}\` |
| **Deployed by** | @${context.actor} |
| **Deployment Time** | ${{ steps.deployment-info.outputs.deployment_time }} |
| **Staging URL** | ${stagingUrl} |

**QC Plan Level 2.1**: âœ… Complete

---
*Automated by Staging Deployment Bot*`;
            
            try {
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
                console.log(`âœ… Updated Staging Deployment Bot comment`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: comment
                });
                console.log(`âœ… Posted Staging Deployment Bot comment`);
              }
            } catch (error) {
              console.log(`âš ï¸ Error posting comment: ${error.message}`);
            }

      - name: Generate deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'staging' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ steps.deployment-info.outputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Author | ${{ steps.deployment-info.outputs.author }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Time | ${{ steps.deployment-info.outputs.deployment_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY

