name: Update Release Board

on:
  issues:
    types: [opened, labeled, closed]
  pull_request:
    types: [opened, synchronize, closed, labeled]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  update-board:
    name: Update Release Board
    runs-on: ubuntu-latest
    # Run for all PRs and release-request issues
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issues' && (github.event.issue.labels.*.name == 'release-request' || contains(github.event.issue.title, 'Release Request')))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find or Create Release Board
        id: find-board
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Try to find existing board
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              let board = projects.data.find(
                p => p.name === 'DevOps Release Board' || p.name === 'Release Tracking Board'
              );
              
              if (board) {
                core.setOutput('board_id', board.id.toString());
                core.setOutput('board_url', board.html_url);
                core.setOutput('board_exists', 'true');
                console.log(`âœ… Found existing board: ${board.html_url}`);
              } else {
                // Board doesn't exist, create it
                console.log('ðŸ“‹ Board not found. Creating new board...');
                
                const columns = [
                  "ðŸ“‹ Backlog",
                  "ðŸš€ Ready for Development",
                  "âš™ï¸ In Progress",
                  "ðŸ” PR Raised",
                  "ðŸ‘€ In Review",
                  "âœ… QA Certification",
                  "ðŸš€ Staging Deployment",
                  "ðŸ“ Release Authorization",
                  "ðŸŒ Production Deployment",
                  "âœ… Done"
                ];
                
                board = await github.rest.projects.createForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: "DevOps Release Board",
                  body: `Release tracking board aligned with QC Plan workflow.

This board tracks releases through the three-level validation process:
- Level 1: Peer Review (In Review column)
- Level 2: QA Certification (QA Certification column)
- Level 3: Release Authorization (Release Authorization column)

Each release request is automatically tracked with a unique Request ID.`
                });
                
                console.log(`âœ… Created new board: ${board.data.html_url}`);
                
                // Create columns
                for (const col of columns) {
                  try {
                    await github.rest.projects.createColumn({
                      project_id: board.data.id,
                      name: col
                    });
                    console.log(`  âœ… Created column: ${col}`);
                  } catch (colError) {
                    console.log(`  âš ï¸ Error creating column ${col}: ${colError.message}`);
                  }
                }
                
                core.setOutput('board_id', board.data.id.toString());
                core.setOutput('board_url', board.data.html_url);
                core.setOutput('board_exists', 'false');
                console.log('âœ… Board setup complete!');
              }
            } catch (error) {
              console.log('âš ï¸ Error with board:', error.message);
              console.log('ðŸ’¡ Tip: Ensure Projects are enabled in Repository Settings â†’ General â†’ Features');
              // Don't fail the workflow, just log the error
              core.setOutput('board_exists', 'false');
              core.setOutput('board_id', '');
              core.setOutput('board_url', '');
            }

      - name: Get Board Columns
        id: get-columns
        if: steps.find-board.outputs.board_exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const boardId = parseInt('${{ steps.find-board.outputs.board_id }}');
            if (!boardId) {
              core.setOutput('columns', '{}');
              return;
            }
            
            try {
              const columns = await github.rest.projects.listColumns({
                project_id: boardId,
              });
              
              const columnMap = {};
              for (const col of columns.data) {
                // Map column names to IDs (handle emoji variations)
                const name = col.name.toLowerCase();
                if (name.includes('backlog')) columnMap['backlog'] = col.id;
                if (name.includes('ready for development')) columnMap['ready'] = col.id;
                if (name.includes('in progress')) columnMap['in_progress'] = col.id;
                if (name.includes('pr raised')) columnMap['pr_raised'] = col.id;
                if (name.includes('in review')) columnMap['in_review'] = col.id;
                if (name.includes('qa certification')) columnMap['qa'] = col.id;
                if (name.includes('staging deployment')) columnMap['staging'] = col.id;
                if (name.includes('release authorization')) columnMap['authorization'] = col.id;
                if (name.includes('production deployment')) columnMap['production'] = col.id;
                if (name.includes('done')) columnMap['done'] = col.id;
              }
              
              core.setOutput('columns', JSON.stringify(columnMap));
              console.log('âœ… Found columns:', Object.keys(columnMap).join(', '));
            } catch (error) {
              console.log('âš ï¸ Error getting columns:', error.message);
              core.setOutput('columns', '{}');
            }

      - name: Determine Issue/PR and Status
        id: determine-status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let issueNumber, targetColumn, contentId, contentType;
            
            if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
              contentType = 'Issue';
              contentId = context.payload.issue.id;
              const labels = context.payload.issue.labels.map(l => l.name);
              const state = context.payload.issue.state;
              
              // Determine column based on issue state and labels
              if (labels.includes('release-request')) {
                if (state === 'closed') {
                  targetColumn = 'done';
                } else if (labels.includes('approved')) {
                  targetColumn = 'authorization';
                } else if (labels.includes('qa-certified')) {
                  targetColumn = 'qa';
                } else {
                  targetColumn = 'backlog';
                }
              } else {
                // Regular issues go to backlog
                targetColumn = 'backlog';
              }
            } else if (context.payload.pull_request) {
              issueNumber = context.payload.pull_request.number;
              contentType = 'PullRequest';
              contentId = context.payload.pull_request.id;
              const state = context.payload.pull_request.state;
              const merged = context.payload.pull_request.merged;
              const draft = context.payload.pull_request.draft;
              const baseRef = context.payload.pull_request.base.ref;
              
              if (merged && state === 'closed') {
                // Merged PRs - check target branch
                if (baseRef === 'main' || baseRef === 'master') {
                  targetColumn = 'production';
                } else if (baseRef === 'develop' || baseRef === 'staging') {
                  targetColumn = 'staging';
                } else {
                  targetColumn = 'done';
                }
              } else if (state === 'closed' && !merged) {
                // Closed but not merged - done or backlog
                targetColumn = 'done';
              } else if (state === 'open') {
                // Open PRs - determine stage
                if (draft) {
                  targetColumn = 'in_progress';
                } else {
                  // Check if PR has reviews
                  try {
                    const reviews = await github.rest.pulls.listReviews({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: issueNumber,
                    });
                    
                    const hasApprovals = reviews.data.some(r => r.state === 'APPROVED');
                    const hasChangesRequested = reviews.data.some(r => r.state === 'CHANGES_REQUESTED');
                    
                    if (hasApprovals && !hasChangesRequested) {
                      // Approved - move to QA or staging
                      if (baseRef === 'main' || baseRef === 'master') {
                        targetColumn = 'authorization';
                      } else {
                        targetColumn = 'qa';
                      }
                    } else if (reviews.data.length > 0) {
                      // Has reviews but not approved
                      targetColumn = 'in_review';
                    } else {
                      // No reviews yet
                      targetColumn = 'pr_raised';
                    }
                  } catch (error) {
                    // If we can't check reviews, default to pr_raised
                    targetColumn = 'pr_raised';
                  }
                }
              } else {
                targetColumn = 'backlog';
              }
            }
            
            core.setOutput('issue_number', issueNumber.toString());
            core.setOutput('target_column', targetColumn || 'backlog');
            core.setOutput('content_id', contentId.toString());
            core.setOutput('content_type', contentType);
            console.log(`ðŸ“‹ ${contentType} #${issueNumber} â†’ Column: ${targetColumn}`);

      - name: Add Card to Board
        if: steps.find-board.outputs.board_exists == 'true' && steps.get-columns.outputs.columns != '{}'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const boardId = parseInt('${{ steps.find-board.outputs.board_id }}');
            if (!boardId) {
              console.log('âš ï¸ No board ID available');
              return;
            }
            
            const columns = JSON.parse('${{ steps.get-columns.outputs.columns }}' || '{}');
            if (Object.keys(columns).length === 0) {
              console.log('âš ï¸ No columns found');
              return;
            }
            
            const issueNumber = parseInt('${{ steps.determine-status.outputs.issue_number }}');
            const targetColumn = '${{ steps.determine-status.outputs.target_column }}';
            
            let columnId = columns[targetColumn];
            if (!columnId) {
              console.log(`âš ï¸ Column '${targetColumn}' not found. Using backlog.`);
              // Use first column as fallback
              try {
                const allColumns = await github.rest.projects.listColumns({
                  project_id: boardId,
                });
                if (allColumns.data.length > 0) {
                  columnId = allColumns.data[0].id;
                } else {
                  console.log('âš ï¸ No columns found in board');
                  return;
                }
              } catch (err) {
                console.log('âš ï¸ Error getting columns:', err.message);
                return;
              }
            }
            
            try {
              const contentId = parseInt('${{ steps.determine-status.outputs.content_id }}');
              const contentType = '${{ steps.determine-status.outputs.content_type }}';
              
              // Search for existing card across all columns
              let existingCard = null;
              let existingColumnId = null;
              
              // Check all columns for existing card
              for (const [colName, colId] of Object.entries(columns)) {
                try {
                  const cards = await github.rest.projects.listCards({
                    column_id: colId,
                  });
                  
                  existingCard = cards.data.find(card => {
                    return card.content_url && (
                      card.content_url.includes(`/issues/${issueNumber}`) ||
                      card.content_url.includes(`/pull/${issueNumber}`)
                    );
                  });
                  
                  if (existingCard) {
                    existingColumnId = colId;
                    break;
                  }
                } catch (err) {
                  // Continue searching other columns
                }
              }
              
              if (existingCard) {
                // Move card to new column if needed
                if (existingColumnId === columnId) {
                  console.log(`âœ… Card already in correct column: ${targetColumn}`);
                } else {
                  await github.rest.projects.moveCard({
                    card_id: existingCard.id,
                    position: 'top',
                    column_id: columnId,
                  });
                  console.log(`âœ… Moved card from ${existingColumnId} to ${targetColumn} column`);
                }
              } else {
                // Create new card
                await github.rest.projects.createCard({
                  column_id: columnId,
                  content_id: contentId,
                  content_type: contentType,
                });
                console.log(`âœ… Created ${contentType} card in ${targetColumn} column`);
              }
            } catch (error) {
              console.log(`âš ï¸ Error managing card: ${error.message}`);
              // Don't fail the workflow, just log the error
            }
      
      - name: Skip board update if not available
        if: steps.find-board.outputs.board_exists != 'true'
        run: |
          echo "âš ï¸ Board not available. Skipping board update."
          echo "ðŸ’¡ To enable board tracking:"
          echo "   1. Enable Projects in Repository Settings â†’ General â†’ Features"
          echo "   2. Run the 'Auto Create Release Board' workflow"

      - name: Summary
        run: |
          echo "## ðŸ“Š Board Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Updated release board with issue/PR #${{ steps.determine-status.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Column**: ${{ steps.determine-status.outputs.target_column }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Board](${{ steps.find-board.outputs.board_url }})" >> $GITHUB_STEP_SUMMARY

