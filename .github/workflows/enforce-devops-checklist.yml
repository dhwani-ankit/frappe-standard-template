name: Enforce DevOps Checklist

on:
  pull_request:
    types: [edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  enforce-checklist:
    name: Enforce DevOps Checklist
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            
            // Check if DevOps checklist section was manually edited
            const devopsSectionRegex = /## üîß DevOps Checklist.*?Do not edit this section manually\./s;
            const hasDevopsSection = devopsSectionRegex.test(prBody);
            
            if (hasDevopsSection) {
              // If someone tried to edit it, restore the template
              const template = `## üîß DevOps Checklist (AUTOMATED - DO NOT EDIT)

> ‚ö†Ô∏è **This section is automatically managed by DevOps Bot. Any manual edits will be overwritten.**

The DevOps Checklist will appear here automatically when the PR is created. It tracks:
- CI/CD Pipeline status
- Staging Deployment
- Security Scans
- Code Coverage
- E2E Tests
- Breaking Changes

**Do not edit this section manually.**`;
              
              // Replace the DevOps section with template
              const updatedBody = prBody.replace(
                /## üîß DevOps Checklist.*?Do not edit this section manually\./s,
                template
              );
              
              if (updatedBody !== prBody) {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  body: updatedBody
                });
                
                // Post warning comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `‚ö†Ô∏è **DevOps Checklist Protection**

The DevOps Checklist section is automatically managed by bots and cannot be manually edited. Your changes have been reverted.

The checklist will be automatically updated by the DevOps Checklist Bot based on CI/CD status, deployments, and test results.

---
*Automated by DevOps Checklist Enforcer*`
                });
                
                console.log('‚úÖ Restored DevOps checklist template');
              }
            }

