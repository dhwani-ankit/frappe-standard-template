name: Release Approval Workflow

on:
  issues:
    types: [opened, labeled, closed]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      request_id:
        description: 'Release Request ID'
        required: true
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  check-release-request:
    name: Check Release Request Status
    runs-on: ubuntu-latest
    if: |
      github.event.issue.labels.*.name == 'release-request' ||
      contains(github.event.issue.title, 'Release Request')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse Request ID
        id: parse-request
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            REQUEST_ID="${{ github.event.inputs.request_id }}"
          else
            REQUEST_ID=$(echo "${{ github.event.issue.title }}" | grep -oP 'REL-\d{8}-[A-Z0-9]+' | head -1)
          fi
          
          if [ -z "$REQUEST_ID" ]; then
            echo "âš ï¸  Request ID not found"
            exit 1
          fi
          
          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT
          echo "âœ… Found Request ID: $REQUEST_ID"

      - name: Load Request Data
        id: load-request
        run: |
          REQUEST_ID="${{ steps.parse-request.outputs.request_id }}"
          REQUEST_FILE=".github/release-requests/${REQUEST_ID}.json"
          
          if [ ! -f "$REQUEST_FILE" ]; then
            echo "âš ï¸  Request file not found: $REQUEST_FILE"
            exit 1
          fi
          
          PR_NUMBER=$(jq -r '.pr_number' "$REQUEST_FILE")
          STATUS=$(jq -r '.status' "$REQUEST_FILE")
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "current_status=$STATUS" >> $GITHUB_OUTPUT
          echo "âœ… Loaded request data"

      - name: Check Approval Status
        id: check-approval
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) {
              core.setFailed('No issue number found');
              return;
            }
            
            // Get issue comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            
            // Check for approval keywords
            const approvalKeywords = ['/approve', 'approved', 'go', 'go-ahead', 'âœ… approved'];
            const rejectionKeywords = ['/reject', 'rejected', 'no-go', 'âŒ rejected'];
            
            let hasApproval = false;
            let hasRejection = false;
            let approver = null;
            let rejector = null;
            
            for (const comment of comments.data) {
              const body = comment.body.toLowerCase();
              
              if (approvalKeywords.some(keyword => body.includes(keyword.toLowerCase()))) {
                hasApproval = true;
                approver = comment.user.login;
                break;
              }
              
              if (rejectionKeywords.some(keyword => body.includes(keyword.toLowerCase()))) {
                hasRejection = true;
                rejector = comment.user.login;
                break;
              }
            }
            
            // Check issue labels
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            
            const labels = issue.data.labels.map(l => l.name);
            const isApproved = labels.includes('approved') || labels.includes('ready-for-deployment');
            const isRejected = labels.includes('rejected') || labels.includes('blocked');
            
            core.setOutput('has_approval', hasApproval || isApproved);
            core.setOutput('has_rejection', hasRejection || isRejected);
            core.setOutput('approver', approver || '');
            core.setOutput('rejector', rejector || '');

      - name: Update Request Status
        id: update-status
        run: |
          REQUEST_ID="${{ steps.parse-request.outputs.request_id }}"
          REQUEST_FILE=".github/release-requests/${REQUEST_ID}.json"
          
          if [ "${{ steps.check-approval.outputs.has_approval }}" == "true" ]; then
            STATUS="approved"
            MESSAGE="âœ… Release request APPROVED"
          elif [ "${{ steps.check-approval.outputs.has_rejection }}" == "true" ]; then
            STATUS="rejected"
            MESSAGE="âŒ Release request REJECTED"
          else
            STATUS="pending"
            MESSAGE="ðŸŸ¡ Release request PENDING approval"
          fi
          
          # Update JSON file
          jq --arg status "$STATUS" '.status = $status' "$REQUEST_FILE" > "${REQUEST_FILE}.tmp"
          mv "${REQUEST_FILE}.tmp" "$REQUEST_FILE"
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "$MESSAGE"

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue?.number;
            if (!issueNumber) return;
            
            const status = '${{ steps.update-status.outputs.status }}';
            const message = '${{ steps.update-status.outputs.message }}';
            const approver = '${{ steps.check-approval.outputs.approver }}';
            const rejector = '${{ steps.check-approval.outputs.rejector }}';
            
            let comment = `## ${message}\n\n`;
            comment += `**Request ID**: \`${{ steps.parse-request.outputs.request_id }}\`\n`;
            comment += `**Status**: ${status.toUpperCase()}\n`;
            
            if (approver) {
              comment += `**Approved by**: @${approver}\n`;
            }
            if (rejector) {
              comment += `**Rejected by**: @${rejector}\n`;
            }
            
            comment += `\n**Next Steps**:\n`;
            
            if (status === 'approved') {
              comment += `- [ ] Proceed with production deployment\n`;
              comment += `- [ ] Monitor deployment status\n`;
              comment += `- [ ] Update status to 'deployed' after successful deployment\n`;
            } else if (status === 'rejected') {
              comment += `- [ ] Address rejection reasons\n`;
              comment += `- [ ] Resubmit release request if needed\n`;
            } else {
              comment += `- [ ] Wait for approval from Team Lead, QA Lead, or DevOps\n`;
              comment += `- [ ] Comment '/approve' or '/reject' to update status\n`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

      - name: Generate Status Summary
        run: |
          echo "## Release Request Status Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Request ID | \`${{ steps.parse-request.outputs.request_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | #${{ steps.load-request.outputs.pr_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.update-status.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Message | ${{ steps.update-status.outputs.message }} |" >> $GITHUB_STEP_SUMMARY

