name: Auto Create Release Board

on:
  workflow_dispatch:
  repository:
    types: [created]
  # Also trigger on first push to main/master
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/create-release-board.yml'

permissions:
  contents: read
  repository-projects: write

jobs:
  create-board:
    name: Create Release Tracking Board
    runs-on: ubuntu-latest
    # Only run if board doesn't exist
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'repository' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if board already exists
        id: check-board
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const projects = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const existingBoard = projects.data.find(
                p => p.name === 'DevOps Release Board' || p.name === 'Release Tracking Board'
              );
              
              if (existingBoard) {
                core.setOutput('exists', 'true');
                core.setOutput('board_id', existingBoard.id.toString());
                core.setOutput('board_url', existingBoard.html_url);
                console.log(`âœ… Board already exists: ${existingBoard.html_url}`);
              } else {
                core.setOutput('exists', 'false');
                console.log('ðŸ“‹ Board does not exist, will create new one');
              }
            } catch (error) {
              console.log('âš ï¸ Error checking for existing board:', error.message);
              core.setOutput('exists', 'false');
            }

      - name: Create Release Tracking Board
        if: steps.check-board.outputs.exists != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const columns = [
              "ðŸ“‹ Backlog",
              "ðŸš€ Ready for Development",
              "âš™ï¸ In Progress",
              "ðŸ” PR Raised",
              "ðŸ‘€ In Review",
              "âœ… QA Certification",
              "ðŸš€ Staging Deployment",
              "ðŸ“ Release Authorization",
              "ðŸŒ Production Deployment",
              "âœ… Done"
            ];

            console.log('Creating Release Tracking Board...');
            
            const project = await github.rest.projects.createForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "DevOps Release Board",
              body: `Release tracking board aligned with QC Plan workflow.

This board tracks releases through the three-level validation process:
- Level 1: Peer Review (In Review column)
- Level 2: QA Certification (QA Certification column)
- Level 3: Release Authorization (Release Authorization column)

Each release request is automatically tracked with a unique Request ID.`
            });

            console.log(`âœ… Created project board: ${project.data.html_url}`);
            core.setOutput('board_id', project.data.id.toString());
            core.setOutput('board_url', project.data.html_url);

            // Create columns
            console.log('Creating board columns...');
            for (const col of columns) {
              try {
                const column = await github.rest.projects.createColumn({
                  project_id: project.data.id,
                  name: col
                });
                console.log(`  âœ… Created column: ${col}`);
              } catch (error) {
                console.log(`  âš ï¸ Error creating column ${col}:`, error.message);
              }
            }

            console.log('âœ… Board setup complete!');
            
            // Set outputs for next steps
            core.setOutput('board_id', project.data.id.toString());
            core.setOutput('board_url', project.data.html_url);

      - name: Use existing board
        if: steps.check-board.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('Using existing board');
            core.setOutput('board_id', '${{ steps.check-board.outputs.board_id }}');
            core.setOutput('board_url', '${{ steps.check-board.outputs.board_url }}');

      - name: Create board automation workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const boardId = '${{ steps.check-board.outputs.exists == "true" && steps.check-board.outputs.board_id || steps.create-board.outputs.board_id }}';
            const boardUrl = '${{ steps.check-board.outputs.exists == "true" && steps.check-board.outputs.board_url || steps.create-board.outputs.board_url }}';
            
            console.log('\nðŸ“Š Release Tracking Board Information:');
            console.log(`   Board ID: ${boardId}`);
            console.log(`   Board URL: ${boardUrl}`);
            console.log('\nðŸ’¡ Next Steps:');
            console.log('   1. The board is ready to track release requests');
            console.log('   2. Release requests will be automatically added to the board');
            console.log('   3. Use the board to track progress through QC Plan levels');
            console.log('\nðŸ“‹ Board Columns:');
            console.log('   - ðŸ“‹ Backlog: New release requests');
            console.log('   - ðŸš€ Ready for Development: Approved for development');
            console.log('   - âš™ï¸ In Progress: Currently being developed');
            console.log('   - ðŸ” PR Raised: Pull request created');
            console.log('   - ðŸ‘€ In Review: Level 1 - Peer Review');
            console.log('   - âœ… QA Certification: Level 2 - QA Testing');
            console.log('   - ðŸš€ Staging Deployment: Deployed to staging');
            console.log('   - ðŸ“ Release Authorization: Level 3 - Approval');
            console.log('   - ðŸŒ Production Deployment: Deployed to production');
            console.log('   - âœ… Done: Release completed');

      - name: Generate summary
        run: |
          echo "## ðŸŽ¯ Release Tracking Board Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Board Status**: ${{ steps.check-board.outputs.exists == 'true' && 'Already Exists' || 'Created Successfully' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-board.outputs.exists }}" != "true" ]; then
            echo "ðŸ”— **Board URL**: ${{ steps.create-board.outputs.board_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”— **Board URL**: ${{ steps.check-board.outputs.board_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Board Columns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The board includes columns aligned with QC Plan workflow:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ“‹ **Backlog** - New release requests" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸš€ **Ready for Development** - Approved for development" >> $GITHUB_STEP_SUMMARY
          echo "3. âš™ï¸ **In Progress** - Currently being developed" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ” **PR Raised** - Pull request created" >> $GITHUB_STEP_SUMMARY
          echo "5. ðŸ‘€ **In Review** - Level 1: Peer Review" >> $GITHUB_STEP_SUMMARY
          echo "6. âœ… **QA Certification** - Level 2: QA Testing" >> $GITHUB_STEP_SUMMARY
          echo "7. ðŸš€ **Staging Deployment** - Deployed to staging" >> $GITHUB_STEP_SUMMARY
          echo "8. ðŸ“ **Release Authorization** - Level 3: Approval" >> $GITHUB_STEP_SUMMARY
          echo "9. ðŸŒ **Production Deployment** - Deployed to production" >> $GITHUB_STEP_SUMMARY
          echo "10. âœ… **Done** - Release completed" >> $GITHUB_STEP_SUMMARY

