name: Staging Deployment Bot

on:
  workflow_run:
    workflows: ["Staging Deployment"]
    types: [completed]
  deployment_status:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number (optional)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  staging-bot:
    name: Staging Deployment Bot
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify PR of Staging Deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Find PRs that reference this deployment
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const latestDeployment = deployments.data[0];
            if (!latestDeployment) return;
            
            // Get deployment status
            const statuses = await github.rest.repos.listDeploymentStatuses({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: latestDeployment.id,
            });
            
            const latestStatus = statuses.data[0];
            if (!latestStatus) return;
            
            // Find PRs for this ref
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${latestDeployment.ref}`,
              state: 'open',
            });
            
            for (const pr of prs.data) {
              const statusEmoji = latestStatus.state === 'success' ? '‚úÖ' : '‚ùå';
              const statusText = latestStatus.state === 'success' ? 'Deployed Successfully' : 'Deployment Failed';
              
              const comment = `## ü§ñ Staging Deployment Bot

${statusEmoji} **Staging Deployment**: ${statusText}
- Environment: ${latestDeployment.environment}
- Status: ${latestStatus.state}
- URL: ${latestStatus.environment_url || 'N/A'}

**QC Plan Level 2.1**: ${latestStatus.state === 'success' ? '‚úÖ Complete' : '‚ùå Failed'}

---
*Automated by Staging Deployment Bot*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

