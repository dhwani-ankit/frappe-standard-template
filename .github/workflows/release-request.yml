name: Release Request Sender

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: string
      send_email:
        description: 'Send email notification'
        required: false
        default: false
        type: boolean
  issue_comment:
    types: [created]
    # Trigger when someone comments /release-request on an issue or PR
  pull_request:
    types: [closed]
    # Trigger when PR is merged to main/master

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-release-request:
    name: Create Release Request
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/release-request')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'master'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Determine PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            # Extract PR number from comment or issue
            PR_NUMBER=$(echo "${{ github.event.comment.body }}" | grep -oP '#\K\d+' | head -1)
            if [ -z "$PR_NUMBER" ]; then
              PR_NUMBER="${{ github.event.issue.number }}"
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          if [ -z "$PR_NUMBER" ]; then
            echo "âŒ Could not determine PR number"
            exit 1
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PR Number: $PR_NUMBER"

      - name: Generate Request ID
        id: generate-request-id
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          UNIQUE_ID=$(openssl rand -hex 4 | tr '[:lower:]' '[:upper:]')
          REQUEST_ID="REL-${TIMESTAMP}-${UNIQUE_ID}"
          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT
          echo "âœ… Generated Request ID: $REQUEST_ID"

      - name: Fetch PR Details
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr-number.outputs.pr_number }}');
            
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            core.setOutput('title', pr.data.title);
            core.setOutput('author', pr.data.user.login);
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('body', pr.data.body || '');

      - name: Generate Deployment Plan
        id: deployment-plan
        run: |
          python .github/helper/deployment-plan-generator.py \
            --pr-number "${{ steps.pr-number.outputs.pr_number }}" \
            --output ".github/release-requests/${{ steps.generate-request-id.outputs.request_id }}-deployment-plan.md"

      - name: Create Release Request Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const requestId = '${{ steps.generate-request-id.outputs.request_id }}';
            const prNumber = parseInt('${{ steps.pr-number.outputs.pr_number }}');
            const prTitle = '${{ steps.pr-details.outputs.title }}';
            const prAuthor = '${{ steps.pr-details.outputs.author }}';
            const prUrl = '${{ steps.pr-details.outputs.pr_url }}';
            
            const issueBody = `# Release Request: ${requestId}

## Request Details

- **Request ID**: \`${requestId}\`
- **PR Number**: #${prNumber}
- **Request Date**: ${new Date().toISOString()}
- **Requested By**: @${context.actor}

## PR Information

- **Title**: ${prTitle}
- **Author**: @${prAuthor}
- **PR URL**: ${prUrl}

## QC Plan Compliance Checklist

### Level 1: Peer Review
- [ ] Code reviewed by at least one peer
- [ ] All reviewer comments resolved
- [ ] Coding standards followed
- [ ] Sensitive logic documented
- [ ] Screenshots/review notes attached

### Level 2: QA Certification
- [ ] Deployed to staging/UAT
- [ ] Test cases executed
- [ ] No high/critical bugs
- [ ] Known issues listed
- [ ] Regression testing completed

### Level 3: Release Authorization
- [ ] Deployment plan prepared
- [ ] Rollback steps documented
- [ ] Downtime estimate provided
- [ ] Stakeholders informed
- [ ] Go/No-Go decision recorded

## Deployment Plan

See deployment plan in release request artifacts.

## Status

- **Status**: ðŸŸ¡ Pending Approval
- **Request ID**: \`${requestId}\`

---

*This issue was automatically created by the Release Request Sender Tool*`;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release Request: ${requestId} - PR #${prNumber}`,
              body: issueBody,
              labels: ['release-request', 'production-deployment'],
            });
            
            core.setOutput('issue_number', issue.data.number.toString());
            core.setOutput('issue_url', issue.data.html_url);
            console.log(`âœ… Created issue #${issue.data.number}: ${issue.data.html_url}`);

      - name: Generate Rollback Script
        run: |
          REQUEST_ID="${{ steps.generate-request-id.outputs.request_id }}"
          GENERATED_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          mkdir -p .github/release-requests
          cat > ".github/release-requests/${REQUEST_ID}-rollback.sh" << EOF
          #!/bin/bash
          # Rollback Script
          # Request ID: ${REQUEST_ID}
          # Generated: ${GENERATED_DATE}
          
          set -e
          
          echo 'ðŸ”„ Starting rollback process...'
          
          # Step 1: Revert code
          echo 'Step 1: Reverting code to previous version'
          # git checkout <previous-commit>
          
          # Step 2: Restore database (if needed)
          echo 'Step 2: Checking if database restore is needed'
          # bench --site <site> restore <backup-file>
          
          # Step 3: Restart services
          echo 'Step 3: Restarting services'
          # bench restart
          
          # Step 4: Verify rollback
          echo 'Step 4: Verifying rollback'
          # Add verification commands here
          
          echo 'âœ… Rollback completed successfully'
          EOF
          chmod +x ".github/release-requests/${REQUEST_ID}-rollback.sh"
          echo "âœ… Rollback script generated"

      - name: Save Request Metadata
        run: |
          REQUEST_ID="${{ steps.generate-request-id.outputs.request_id }}"
          mkdir -p .github/release-requests
          cat > ".github/release-requests/${REQUEST_ID}.json" << EOF
          {
            "request_id": "${REQUEST_ID}",
            "pr_number": ${{ steps.pr-number.outputs.pr_number }},
            "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "status": "pending",
            "issue_number": ${{ steps.create-issue.outputs.issue_number }},
            "issue_url": "${{ steps.create-issue.outputs.issue_url }}"
          }
          EOF
          echo "âœ… Request metadata saved"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr-number.outputs.pr_number }}');
            const requestId = '${{ steps.generate-request-id.outputs.request_id }}';
            const issueUrl = '${{ steps.create-issue.outputs.issue_url }}';
            
            const comment = `## ðŸš€ Release Request Created
            
            **Request ID**: \`${requestId}\`
            **Status**: ðŸŸ¡ Pending Approval
            
            **Tracking Issue**: ${issueUrl}
            
            **Next Steps**:
            1. Complete all QC Plan Level 1 items (Peer Review)
            2. Complete all QC Plan Level 2 items (QA Certification)
            3. Review deployment plan in the tracking issue
            4. Approve or reject the release request
            
            **QC Plan Compliance**:
            - [ ] Level 1: Peer Review âœ…
            - [ ] Level 2: QA Certification â³
            - [ ] Level 3: Release Authorization â³
            
            ---
            *This release request was automatically created by the Release Request Sender Tool*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Upload release request artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-request-${{ steps.generate-request-id.outputs.request_id }}
          path: |
            .github/release-requests/${{ steps.generate-request-id.outputs.request_id }}*.json
            .github/release-requests/${{ steps.generate-request-id.outputs.request_id }}*.md
            .github/release-requests/${{ steps.generate-request-id.outputs.request_id }}*.sh
          retention-days: 90

