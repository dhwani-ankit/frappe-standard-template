name: Generate Semantic Release
on:
  push:
    branches: [ main, master ]
      
permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  actions: read
  
jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Entire Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      - name: Setup dependencies
        run: |
          npm install @semantic-release/git @semantic-release/exec @semantic-release/github @semantic-release/changelog @semantic-release/commit-analyzer @semantic-release/release-notes-generator --no-save
          
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Create Release and Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ðŸš€ Running semantic-release..."
          echo "ðŸ“‹ Configuration:"
          cat .releaserc | jq '.' || cat .releaserc
          echo ""
          echo "ðŸš€ Creating release with notes..."
          npx semantic-release --debug || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… Semantic-release completed successfully"
            elif [ $EXIT_CODE -eq 1 ]; then
              echo "â„¹ï¸ No release created (no changes detected or already released)"
            else
              echo "âš ï¸ Semantic-release exited with code $EXIT_CODE"
              echo "Check logs above for details"
            fi
            # Don't fail the workflow if no release is needed
            exit 0
          }
          
      - name: Verify Release Created
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });
            
            if (releases.length > 0) {
              const latest = releases[0];
              console.log(`âœ… Latest Release: ${latest.tag_name}`);
              console.log(`   Published: ${latest.published_at}`);
              console.log(`   Draft: ${latest.draft}`);
              console.log(`   Prerelease: ${latest.prerelease}`);
              
              if (latest.body) {
                console.log(`\nðŸ“ Release Notes Preview:`);
                console.log(latest.body.substring(0, 500) + (latest.body.length > 500 ? '...' : ''));
              } else {
                console.log(`âš ï¸ No release notes found`);
              }
              
              core.setOutput('latest_release', latest.tag_name);
              core.setOutput('release_url', latest.html_url);
              core.setOutput('has_notes', latest.body ? 'true' : 'false');
            } else {
              console.log('â„¹ï¸ No releases found');
              core.setOutput('latest_release', 'none');
            }
            
      - name: Verify Tags Created
        if: always()
        run: |
          echo "ðŸ“‹ Checking for created tags..."
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          if [ "$LATEST_TAG" != "none" ]; then
            echo "âœ… Latest tag: $LATEST_TAG"
            echo ""
            echo "Recent tags:"
            git tag -l | tail -5
          else
            echo "â„¹ï¸ No tags found (this is normal if no release was created)"
          fi
          
      - name: Summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let summary = "## ðŸš€ Release Summary\n\n";
            
            // Get latest release
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            if (releases.length > 0) {
              const latest = releases[0];
              summary += `âœ… **Latest Release**: [\`${latest.tag_name}\`](${latest.html_url})\n\n`;
              summary += `- **Published**: ${new Date(latest.published_at).toLocaleString()}\n`;
              summary += `- **Draft**: ${latest.draft ? 'Yes' : 'No'}\n`;
              summary += `- **Prerelease**: ${latest.prerelease ? 'Yes' : 'No'}\n\n`;
              
              if (latest.body) {
                summary += `### ðŸ“ Release Notes\n\n`;
                summary += latest.body.substring(0, 1000);
                if (latest.body.length > 1000) {
                  summary += `\n\n[View full release notes](${latest.html_url})`;
                }
              } else {
                summary += `âš ï¸ **No release notes found**\n\n`;
                summary += `This may indicate an issue with release notes generation.`;
              }
            } else {
              summary += `â„¹ï¸ **No releases found**\n\n`;
              summary += `**Note**: Semantic-release only creates releases when:\n`;
              summary += `- Commits follow conventional commit format (feat:, fix:, etc.)\n`;
              summary += `- There are new changes since the last release\n`;
              summary += `- Commits are on \`main\` or \`master\` branch\n\n`;
              summary += `**Troubleshooting:**\n`;
              summary += `1. Check commit messages follow conventional format\n`;
              summary += `2. Verify commits are on the correct branch\n`;
              summary += `3. Review workflow logs for errors\n`;
            }
            
            // Get recent tags
            const { data: tags } = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });
            
            if (tags.length > 0) {
              summary += `\n### ðŸ·ï¸ Recent Tags\n\n`;
              tags.forEach(tag => {
                summary += `- [\`${tag.name}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tag.name})\n`;
              });
            }
            
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
