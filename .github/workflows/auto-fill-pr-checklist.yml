name: Coding Standards Bot

on:
  pull_request_review:
    types: [submitted, dismissed]
  pull_request:
    types: [opened, synchronize, closed, ready_for_review, labeled, unlabeled]
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number to check'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  coding-standards-bot:
    name: Coding Standards Bot
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.pull_request?.number;
            if (!prNumber) {
              core.setOutput('pr_number', '');
              return;
            }
            
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            core.setOutput('pr_number', prNumber.toString());
            core.setOutput('pr_body', pr.data.body || '');
            core.setOutput('pr_state', pr.data.state);
            core.setOutput('pr_merged', pr.data.merged ? 'true' : 'false');

      - name: Get review information
        id: review-info
        if: github.event_name == 'pull_request_review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const review = context.payload.review;
            
            // Get all reviews for this PR
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            // Find approved reviews
            const approvedReviews = reviews.data.filter(r => r.state === 'APPROVED');
            const latestApproval = approvedReviews.length > 0 
              ? approvedReviews[approvedReviews.length - 1] 
              : null;
            
            if (latestApproval) {
              core.setOutput('reviewer', latestApproval.user.login);
              core.setOutput('review_date', new Date(latestApproval.submitted_at).toISOString().split('T')[0]);
              core.setOutput('has_approval', 'true');
            } else {
              core.setOutput('has_approval', 'false');
            }
            
            // Check if all review comments are resolved
            const reviewComments = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            const unresolvedComments = reviewComments.data.filter(c => !c.in_reply_to_id);
            core.setOutput('unresolved_comments', unresolvedComments.length.toString());

      - name: Update PR checklist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr-details.outputs.pr_number }}');
            if (!prNumber) return;
            
            let prBody = '${{ steps.pr-details.outputs.pr_body }}' || '';
            const originalBody = prBody;
            
            // Update 1.1 - Code reviewed
            if ('${{ steps.review-info.outputs.has_approval }}' === 'true') {
              const reviewer = '@${{ steps.review-info.outputs.reviewer }}';
              const reviewDate = '${{ steps.review-info.outputs.review_date }}';
              
              // Update checklist item 1.1 - handle various formats
              const patterns = [
                // Pattern 1: Unchecked with placeholders
                /- \[ \] \*\*1\.1\*\* Code reviewed by at least one peer[\s\S]*?- Review Date: [^\n]+/,
                // Pattern 2: Unchecked with underscores
                /- \[ \] \*\*1\.1\*\* Code reviewed by at least one peer[\s\S]*?- Review Date: ________________/,
                // Pattern 3: Already checked but needs update
                /- \[x\] \*\*1\.1\*\* Code reviewed by at least one peer[\s\S]*?- Review Date: [^\n]+/,
                // Pattern 4: With AUTO-FILLED comments
                /- \[ \] \*\*1\.1\*\* Code reviewed by at least one peer[\s\S]*?- Review Date: <!-- AUTO-FILLED: [^\n]+ -->/
              ];
              
              const replacement = `- [x] **1.1** Code reviewed by at least one peer (preferably senior)
  - Reviewer: ${reviewer}
  - Review Date: ${reviewDate}`;
              
              let updated = false;
              for (const pattern of patterns) {
                if (pattern.test(prBody)) {
                  prBody = prBody.replace(pattern, replacement);
                  updated = true;
                  break;
                }
              }
              
              // If no pattern matched, try a more flexible approach
              if (!updated) {
                // Try to find and replace just the reviewer and date lines
                prBody = prBody.replace(
                  /(- \[ \] \*\*1\.1\*\* Code reviewed by at least one peer[\s\S]*?- Reviewer: )[^\n]+/,
                  `$1${reviewer}`
                );
                prBody = prBody.replace(
                  /(- \[ \] \*\*1\.1\*\* Code reviewed by at least one peer[\s\S]*?- Review Date: )[^\n]+/,
                  `$1${reviewDate}`
                );
                // Mark as checked
                prBody = prBody.replace(
                  /- \[ \] \*\*1\.1\*\* Code reviewed/,
                  `- [x] **1.1** Code reviewed`
                );
              }
            }
            
            // Update 1.2 - Comments resolved
            const unresolvedComments = parseInt('${{ steps.review-info.outputs.unresolved_comments }}' || '0');
            if (unresolvedComments === 0 && '${{ steps.review-info.outputs.has_approval }}' === 'true') {
              // Update 1.2 checklist
              prBody = prBody.replace(
                /- \[ \] \*\*1\.2\*\* All reviewer comments resolved[\s\S]*?- \[ \] Reviewer approval received/,
                `- [x] **1.2** All reviewer comments resolved and approved
  - [x] All comments addressed
  - [x] Reviewer approval received`
              );
              
              // Also handle if already partially checked
              prBody = prBody.replace(
                /- \[ \] \*\*1\.2\*\* All reviewer comments resolved[\s\S]*?- \[ \] All comments addressed[\s\S]*?- \[x\] Reviewer approval received/,
                `- [x] **1.2** All reviewer comments resolved and approved
  - [x] All comments addressed
  - [x] Reviewer approval received`
              );
            }
            
            // Update 1.3 - Coding standards (check if CI passed)
            const ciStatus = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });
            
            const allChecksPassed = ciStatus.data.check_runs.every(
              check => check.status === 'completed' && check.conclusion === 'success'
            );
            
            if (allChecksPassed && ciStatus.data.check_runs.length > 0) {
              prBody = prBody.replace(
                /- \[ \] \*\*1\.3\*\* Coding standards and naming conventions followed[\s\S]*?- \[ \] No linting errors/,
                `- [x] **1.3** Coding standards and naming conventions followed
  - [x] Pre-commit hooks passed
  - [x] CI checks passed
  - [x] No linting errors`
              );
            }
            
            // Only update if body changed
            if (prBody !== '${{ steps.pr-details.outputs.pr_body }}') {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body: prBody,
              });
              console.log('‚úÖ Updated PR checklist');
            } else {
              console.log('‚ÑπÔ∏è No checklist updates needed');
            }

      - name: Coding Standards Bot Comment
        if: github.event_name == 'pull_request_review' && steps.review-info.outputs.has_approval == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const reviewer = '@${{ steps.review-info.outputs.reviewer }}';
            const reviewDate = '${{ steps.review-info.outputs.review_date }}';
            
            const comment = `## ü§ñ Coding Standards Bot

‚úÖ **Code Review Verified**
- Reviewer: ${reviewer}
- Date: ${reviewDate}
- Comments Resolved: ${{ steps.review-info.outputs.unresolved_comments == '0' ? '‚úÖ Yes' : '‚è≥ Pending' }}

---
*Automated by Coding Standards Bot*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

