name: Unified Checklist Bot

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled, unlabeled]
  pull_request_review:
    types: [submitted, dismissed]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["E2E Tests", "Staging Deployment", "Quality Checks"]
    types: [completed]
  deployment_status:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  checks: read
  statuses: read
  deployments: read

jobs:
  unified-checklist:
    name: Unified Checklist Bot
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Gather All Status Information
        id: gather-status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || 
                            (context.payload.inputs?.pr_number ? parseInt(context.payload.inputs.pr_number) : null);
            
            if (!prNumber) {
              core.setFailed('PR number not found');
              return;
            }
            
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            // Level 1: Peer Review
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            const approvals = reviews.data.filter(r => r.state === 'APPROVED');
            const hasApproval = approvals.length > 0;
            const latestApproval = approvals.length > 0 ? approvals[approvals.length - 1] : null;
            
            const reviewComments = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            const unresolvedComments = reviewComments.data.filter(c => !c.in_reply_to_id && c.state !== 'RESOLVED');
            
            // Check CI status
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha,
            });
            
            const allChecksPassed = checks.data.check_runs.every(c => 
              c.status === 'completed' && c.conclusion === 'success'
            ) && checks.data.check_runs.length > 0;
            
            // Level 2: QA Certification
            const deployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.ref,
            });
            
            const hasStagingDeployment = deployments.data.some(d => 
              d.environment === 'staging' || d.environment === 'uat'
            );
            
            const testChecks = checks.data.check_runs.filter(check => 
              check.name.includes('test') || check.name.includes('e2e') || check.name.includes('E2E')
            );
            
            const allTestsPassed = testChecks.length > 0 && testChecks.every(c => 
              c.status === 'completed' && c.conclusion === 'success'
            );
            
            const status = {
              level1: {
                '1.1': hasApproval,
                '1.2': hasApproval && unresolvedComments.length === 0,
                '1.3': allChecksPassed,
                reviewer: latestApproval ? latestApproval.user.login : null,
                reviewDate: latestApproval ? latestApproval.submitted_at : null
              },
              level2: {
                '2.1': hasStagingDeployment,
                '2.2': allTestsPassed,
                '2.5': allTestsPassed
              }
            };
            
            core.setOutput('status', JSON.stringify(status));
            core.setOutput('pr_number', prNumber.toString());
            
            return status;

      - name: Post Unified Checklist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.gather-status.outputs.pr_number }}');
            const status = JSON.parse('${{ steps.gather-status.outputs.status }}');
            
            const level1 = status.level1;
            const level2 = status.level2;
            
            const level1Complete = level1['1.1'] && level1['1.2'] && level1['1.3'];
            const level2Complete = level2['2.1'] && level2['2.2'] && level2['2.5'];
            
            // Get existing comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.data.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('üìã QC Plan Checklist')
            );
            
            const comment = `## üìã QC Plan Checklist

### Level 1: Peer Review

| Check | Status | Details |
|-------|--------|---------|
| **1.1** Code reviewed | ${level1['1.1'] ? '‚úÖ' : '‚è≥'} | ${level1['1.1'] ? `Approved by @${level1.reviewer}` : 'Waiting for approval'} |
| **1.2** Comments resolved | ${level1['1.2'] ? '‚úÖ' : '‚è≥'} | ${level1['1.2'] ? 'All resolved' : 'Pending'} |
| **1.3** Coding standards | ${level1['1.3'] ? '‚úÖ' : '‚è≥'} | ${level1['1.3'] ? 'All checks passed' : 'Pending'} |

**Level 1 Status**: ${level1Complete ? '‚úÖ Complete' : '‚è≥ In Progress'}

---

### Level 2: QA Certification

| Check | Status | Details |
|-------|--------|---------|
| **2.1** Staging deployment | ${level2['2.1'] ? '‚úÖ' : '‚è≥'} | ${level2['2.1'] ? 'Deployed' : 'Pending'} |
| **2.2** Test execution | ${level2['2.2'] ? '‚úÖ' : '‚è≥'} | ${level2['2.2'] ? 'All tests passed' : 'Pending'} |
| **2.5** Regression testing | ${level2['2.5'] ? '‚úÖ' : '‚è≥'} | ${level2['2.5'] ? 'E2E tests passed' : 'Pending'} |

**Level 2 Status**: ${level2Complete ? '‚úÖ Complete' : '‚è≥ In Progress'}

---

**Overall Status**: ${level1Complete && level2Complete ? '‚úÖ Ready for Production' : '‚è≥ In Progress'}

---
*Automated by QC Plan Bots*`;
            
            try {
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
                console.log(`‚úÖ Updated unified checklist on PR #${prNumber}`);
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: comment
                });
                console.log(`‚úÖ Posted unified checklist on PR #${prNumber}`);
              }
            } catch (error) {
              console.log(`‚ö†Ô∏è Error posting comment: ${error.message}`);
            }

